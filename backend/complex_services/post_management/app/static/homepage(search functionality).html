<!DOCTYPE html>
<html>
<head>
    <title>Tech-Exchange - Home</title>
    <link rel="stylesheet" type="text/css" href="../css//homepage.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="//code.jquery.com/jquery.min.js"></script>
</head>
<body>
    <header>
        <script id="replace_with_navbar" src="navbar.js"></script>
         <div class="container">
             <div id="carouselExample" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
                 <div class="carousel-inner">
                     <div class="carousel-item active">
                         <a href="marketplace.html">
                             <img src="../assets/1.png" class="d-block w-100" alt="Donate Instead of Waste">
                         </a>
                     </div>
                     <div class="carousel-item">
                         <a href="donation.html">
                             <img src="../assets/2.png" class="d-block w-100" alt="Join Our Donation Drive">
                         </a>
                     </div>
                     <div class="carousel-item">
                         <a href="forum-landingpg.html">
                             <img src="../assets/3.png" class="d-block w-100" alt="Discuss and Collaborate">
                         </a>
                     </div>
                 </div>
                 <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                     <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                     <span class="visually-hidden">Previous</span>
                 </button>
                 <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                     <span class="carousel-control-next-icon" aria-hidden="true"></span>
                     <span class="visually-hidden">Next</span>
                 </button>
             </div>
         </div>
     </header>

     <!-- <div class="album py-5 bg-light"> -->
        <div class="container">
            <div class="col">
                <div class="overflow-auto">
                    <ul class="nav nav-tabs justify-content-center">
                        <li class="nav-filter">
                            <button type="button" class="btn btn-primary btn-square-md" onclick="location.href='category.html?category=Computers'">Computers</button>
                        </li>
                        <li class="nav-filter">
                            <button type="button" class="btn btn-primary btn-square-md" onclick="location.href='category.html?category=Mobile Phones and Accessories'">Mobile Phones & Accessories</button>
                        </li>
                        <li class="nav-filter">
                            <button type="button" class="btn btn-primary btn-square-md" onclick="location.href='category.html?category=Video Gaming'">Video Gaming</button>
                        </li>
                        <li class="nav-filter">
                            <button type="button" class="btn btn-primary btn-square-md" onclick="location.href='category.html?category=TV and Home Appliances'">TV & Home Appliances</button>
                        </li>
                        <li class="nav-filter">
                            <button type="button" class="btn btn-primary btn-square-md" onclick="location.href='category.html?category=Audio'">Audio</button>
                        </li>
                        <li class="nav-filter">
                            <button type="button" class="btn btn-primary btn-square-md" onclick="location.href='category.html?category=Photography'">Photography</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    <!-- </div> -->

     <!-- <div class="album py-5 bg-light"> -->
        <div class="filter-container">
            <button id="toggleSortPrice">Show Cheapest</button>
        </div>
          

            <br><br><br>

            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

    <script type="module">
       import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
       import { getFirestore, collection, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

       // Your web app's Firebase configuration
       const firebaseConfig = {
        apiKey: "AIzaSyACeAF5_819WDlV2PM7FEQQ5R2YGGWklCM",
        authDomain: "techexchange-76048.firebaseapp.com",
        databaseURL: "https://techexchange-76048-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "techexchange-76048",
        storageBucket: "techexchange-76048.appspot.com",
        messagingSenderId: "396217100321",
        appId: "1:396217100321:web:ba771f3033a2caf6ec1b60",
        measurementId: "G-51BT4968FL"
      };

      function formatTimestamp(timestamp) {
    let date;
    if (timestamp.toDate) {
        // If it's a Firestore Timestamp
        date = timestamp.toDate();
    } else if (typeof timestamp === 'string') {
        // If the date is a string
        date = new Date(timestamp);
    } else {
        // If it's already a Date object
        date = timestamp;
    }

    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0'); // Months are 0-indexed
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

      // Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let isShowingCheapestFirst = true;


document.addEventListener('DOMContentLoaded', async () => {
    const params = new URLSearchParams(window.location.search);
    const searchTerm = params.get('search');

    if (searchTerm) {
        // Fetch and display products based on the search term
        let searchQuery = query(collection(db, "post"), where("name", "==", searchTerm));
        const querySnapshot = await getDocs(searchQuery);
        const searchResults = [];

        for (const doc of querySnapshot.docs) {
            const data = doc.data();
            const imgUrl = await getDownloadURL(storageRef(storage, `gs://techexchange-76048.appspot.com/${data.name}.png`));
            const formattedDate = formatTimestamp(data.datetime);

            searchResults.push({
                ...data,
                imgUrl,
                formattedDate
            });
        }

        // Apply the price filter to search results
        fetchAndDisplayProducts(searchResults);
    } else {
        // No search term, just apply the price filter
        fetchAndDisplayProducts();
    }
});

async function fetchAndDisplayProducts(searchResults = null) {
    const itemsContainer = document.querySelector('.row');
    itemsContainer.innerHTML = '';
    let posts = [];

    if (searchResults) {
        posts = searchResults;
    } else {
        let orderPrice = isShowingCheapestFirst ? "asc" : "desc";
        let postsQuery = query(collection(db, "post"), orderBy("price", orderPrice));
        const querySnapshot = await getDocs(postsQuery);

        for (const doc of querySnapshot.docs) {
            const data = doc.data();
            const imgUrl = await getDownloadURL(storageRef(storage, `gs://techexchange-76048.appspot.com/${data.name}.png`));
            const formattedDate = formatTimestamp(data.datetime);

            posts.push({
                ...data,
                imgUrl,
                formattedDate
            });
        }
    }

    // Display the posts
    posts.forEach(data => {
        const cardHtml = `
            <div class="col">
                <div class="card shadow-sm">
                    <img src="${data.imgUrl}" class="d-block w-100" alt="${data.name}">
                    <div class="card-body">
                        <h5 class="card-title">${data.name}</h5>
                        <p class="card-subtitle">$${data.price}</p>
                        <p class="card-text">${data.desc}</p>
                        <p class="card-text">Location: ${data.location.latitude}, ${data.location.longitude}</p>
                        <p class="card-text">Posted on: ${data.formattedDate}</p>
                        <p class="card-text">Category: ${data.category}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">${data.formattedDate}</small>
                        </div>
                    </div>
                </div>
            </div>
        `;

        itemsContainer.innerHTML += cardHtml;
    });
}

function toggleSortOrderPrice() {
    isShowingCheapestFirst = !isShowingCheapestFirst;
    document.getElementById('toggleSortPrice').innerText = isShowingCheapestFirst ? "Show Cheapest" : "Show Expensive";
    applyPriceFilter();
}


    </script>
</body>


</html>
