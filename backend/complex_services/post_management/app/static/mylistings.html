<!DOCTYPE html>
<html>
<head>
    <title>Tech-Exchange - Home</title>
    <link rel="stylesheet" type="text/css" href="../css//homepage.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="//code.jquery.com/jquery.min.js"></script>
</head>
<body>
    <script id="replace_with_navbar" src="navbar.js"></script>

     <!-- <div class="album py-5 bg-light"> -->
        <div class="container">
          <div class="filter-container">
            <button id="toggleSort">Show Oldest</button>
        </div>

            <br><br><br>

            <div class="container">
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3" id="userCardContainer"></div>
              </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, doc, query, where, getDoc, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";
  
    // Your web app's Firebase configuration
    const firebaseConfig = {
      // Your Firebase config
      apiKey: "AIzaSyACeAF5_819WDlV2PM7FEQQ5R2YGGWklCM",
        authDomain: "techexchange-76048.firebaseapp.com",
        databaseURL: "https://techexchange-76048-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "techexchange-76048",
        storageBucket: "techexchange-76048.appspot.com",
        messagingSenderId: "396217100321",
        appId: "1:396217100321:web:ba771f3033a2caf6ec1b60",
        measurementId: "G-51BT4968FL"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    function formatTimestamp(timestamp) {
    let date;
    if (timestamp.toDate) {
        // If it's a Firestore Timestamp
        date = timestamp.toDate();
    } else if (typeof timestamp === 'string') {
        // If the date is a string
        date = new Date(timestamp);
    } else {
        // If it's already a Date object
        date = timestamp;
    }

    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0'); // Months are 0-indexed
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

let isShowingMostRecent = true;

async function getUserDocument(order = "mostRecent") {
    const userDocRef = doc(db, "users", "eke7zjaf5hJFJkleq6jQ");
    const userDocSnap = await getDoc(userDocRef);

    if (userDocSnap.exists()) {
        const postsQuery = query(collection(db, "post"), where("user_id", "==", "eke7zjaf5hJFJkleq6jQ"), orderBy("datetime", order === "mostRecent" ? "desc" : "asc"));
        const querySnapshot = await getDocs(postsQuery);
        const posts = [];
        const userCardContainer = document.getElementById("userCardContainer");

        // Clear previous content only once before rendering new results
        userCardContainer.innerHTML = ''; 

        for (const postDoc of querySnapshot.docs) {
            const postData = postDoc.data();
            const imageRef = storageRef(storage, `gs://techexchange-76048.appspot.com/${postData.name}.png`);
            const imgUrl = await getDownloadURL(imageRef);
            const formattedDate = formatTimestamp(postData.datetime);

            // Create post object and push to posts array
            posts.push({
                ...postData,
                imgUrl,
                formattedDate,
                id: postDoc.id // Include document ID for edit link
            });
        }

      querySnapshot.forEach(async (postDoc) => {
      const postData = postDoc.data();
      console.log(postDoc.id)
      const imageRef = storageRef(storage, `gs://techexchange-76048.appspot.com/${postData.name}.png`);
      const imgUrl = await getDownloadURL(imageRef);

      const locationString = `Latitude: ${postData.location.latitude}, Longitude: ${postData.location.longitude}`;
      const formattedDate = formatTimestamp(postData.datetime);
      const cardHtml = `
        <div class="col">
          <div class="card shadow-sm">
            <img src="${imgUrl}" class="d-block w-100" alt="${postData.name}">
            <a href="editproduct.html?productId=${postDoc.id}" class="btn btn-primary">Edit</a>
            <div class="card-body">
              <h5 class="card-title">${postData.name}</h5>
              <p class="card-text">${postData.desc}</p>
              <p class="card-text">Location: ${locationString}</p>
              <p class="card-text">Posted on: ${formattedDate}</p>
              <p class="card-text">Category: ${postData.category}</p>
              <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">${formattedDate} mins ago</small>
              </div>
            </div>
          </div>
        </div>
      `;
      userCardContainer.innerHTML += cardHtml;
    });
  } else {
    console.log("No such user document!");
  }
}

// Initial call to fetch and render products
getUserDocument("mostRecent");

function toggleSortOrder() {
    isShowingMostRecent = !isShowingMostRecent;
    document.getElementById('toggleSort').innerText = isShowingMostRecent ? "Show Oldest" : "Show Most Recent";
    getUserDocument(isShowingMostRecent ? "mostRecent" : "oldest");
}

document.addEventListener('DOMContentLoaded', (event) => {
    document.getElementById('toggleSort').addEventListener('click', toggleSortOrder);
});

  </script>
  
  </body>


  </html>