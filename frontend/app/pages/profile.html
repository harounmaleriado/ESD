<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="../css/profile.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Tech-Exchange</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="/">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/pages/marketplace.html">Marketplace</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/pages/profile.html">Profile</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/pages/forum.html">Forum</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>
    <div class="container mt-5">
        <div class="row">
            <!-- User Profile Section -->
            <div class="col-md-2 border-end">
                <div class="profile-section">
                    <img id="profilePicture" src="../assets/profilepicture.png" class="img-fluid rounded-circle mb-3"
                        width="70" height="70">
                    <h3 id="userName">Name goes here....</h3>
                    <p id="bio">Bio goes here....</p>
                    <p id="contact">Contact details go here...</p>
                    <p id="email">Email goes here...</p>
                    <div>
                        <input type="file" id="profilePicUpload" accept="image/*">
                        <button onclick="updateProfileInfo()">Save Profile</button>
                    </div>
                </div>
            </div>
            <!-- Tabs for Listings and Orders -->
            <div class="col-md-10">
                <ul class="nav nav-tabs" id="profileTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="listings-tab" data-bs-toggle="tab"
                            data-bs-target="#listings" type="button" role="tab" aria-controls="listings"
                            aria-selected="true">Listings</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders"
                            type="button" role="tab" aria-controls="orders" aria-selected="false">Orders</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews"
                            type="button" role="tab" aria-controls="reviews" aria-selected="false">Reviews</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="chats-tab" data-bs-toggle="tab" data-bs-target="#chats" type="button" role="tab" aria-controls="chats" aria-selected="false">Chats</button>
                    </li>                    
                </ul>
                <div class="tab-content" id="profileTabContent">
                    <div class="tab-pane fade show active" id="listings" role="tabpanel" aria-labelledby="listings-tab">
                        <!-- Content for Listings -->
                        <p>Listings content goes here...</p>
                    </div>
                    <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                        <!-- Content for Orders -->
                        <p>Orders content goes here...</p>
                    </div>
                    <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                        <!-- Content for Reviews -->
                    </div>
                    <div class="tab-pane fade" id="chats" role="tabpanel" aria-labelledby="chats-tab">
                        <!-- Chat invitations will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-storage.js"></script>



        <script>
            let globalUserId = null;
            // Function to parse the JWT and get the payload
            function parseJwt(token) {
                var base64Payload = token.split('.')[1];
                var payload = JSON.parse(window.atob(base64Payload));
                return payload;
            }

            // Function to redirect to login if JWT is not present
            function redirectToLogin() {
                window.location.href = '/pages/login.html'; // Adjust the path as necessary
            }

            // Function to fetch profile data
            async function fetchProfile(userId) {
                try {
                    const response = await fetch(`http://localhost:8000/profile/${userId}`);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const profileData = await response.json();
                    updateProfile(profileData);
                    globalUserId = userId;
                } catch (error) {
                    console.error('Failed to fetch profile:', error);
                }
            }

            // Function to update profile information on the page
            function updateProfile(profileData) {
                document.getElementById('userName').textContent = profileData.name || 'Default Name';
                document.getElementById('profilePicture').src = profileData.profile_pic || '../assets/defaultProfilePic.png';
                document.getElementById('bio').textContent = profileData.bio || 'No bio available.';
                document.getElementById('contact').textContent = profileData.contact_details || 'No contact details available.';
                document.getElementById('email').textContent = profileData.email || 'No email available.';
            }
            async function updateProfileInfo() {
                if (!globalUserId) {
                    console.error('User ID is not available.');
                    return;
                }

                // Create FormData and append profile data
                const formData = new FormData();
                formData.append('name', document.querySelector('.profile-section h3').textContent);
                formData.append('bio', document.getElementById('bio').textContent);
                formData.append('contact', document.getElementById('contact').textContent);
                formData.append('email', document.getElementById('email').textContent);

                // Append the file, if selected
                const profilePicInput = document.getElementById('profilePicUpload');
                if (profilePicInput.files.length > 0) {
                    const file = profilePicInput.files[0];
                    formData.append('profile_pic', file);
                }

                // Send a PUT request with FormData
                try {
                    const response = await fetch(`http://localhost:8000/profile/${globalUserId}`, {
                        method: 'PUT',
                        body: formData, // FormData will automatically set the Content-Type to multipart/form-data
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const result = await response.json();
                    console.log(result.message); // Or handle the updated profile information

                    window.location.reload(); // Reload the page to reflect the changes
                    profilePicInput.value = ''; // Clear the file input
                } catch (error) {
                    console.error('Error updating profile:', error);
                }
            }

            async function fetchReviews(revieweeId) {
                try {
                    const response = await fetch(`http://localhost:8000/review/${revieweeId}`);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const reviewData = await response.json();

                    for (let review of reviewData.reviews) {
                        review.reviewerName = await fetchReviewerName(review.reviewer_id);
                    }

                    displayReviews(reviewData.reviews);
                } catch (error) {
                    console.error('Failed to fetch reviews:', error);
                }
            }

            async function fetchReviewerName(reviewerId) {
                try {
                    const response = await fetch(`http://localhost:8000/profile/${reviewerId}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch reviewer profile');
                    }
                    const reviewerData = await response.json();
                    return reviewerData.name;
                } catch (error) {
                    console.error('Failed to fetch reviewer name:', error);
                    return 'Unknown';
                }
            }

            function displayReviews(reviews) {
                const reviewsContainer = document.getElementById('reviews');
                // Clear previous content
                reviewsContainer.innerHTML = '';
                // Create and append new review elements
                reviews.forEach(review => {
                    const reviewElement = document.createElement('div');
                    reviewElement.classList.add('review');
                    reviewElement.innerHTML = `
                    <p>Reviewer: ${review.reviewerName}</p>
                    <p>Message: ${review.message}</p>
                    <p>Rating: ${review.rating}</p>
                `;
                    reviewsContainer.appendChild(reviewElement);
                });
            }

            async function fetchListings(userId) {
                try {
                    const response = await fetch(`http://localhost:8000/listings/${userId}`);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const listings = await response.json();
                    displayListings(listings); // Assuming the API returns an object with a listings array
                } catch (error) {
                    console.error('Failed to fetch listings:', error);
                }
            }

            function displayListings(listings) {
                const listingsContainer = document.getElementById('listings');
                // Clear previous content
                listingsContainer.innerHTML = '<h4>Your Listings</h4>';
                if (listings && Array.isArray(listings)) {
                    listings.forEach(listing => {
                        // Create a Bootstrap card for each listing
                        const card = document.createElement('div');
                        card.className = 'card mb-3';
                        card.style.width = '18rem'; // Adjust card width as needed

                        // Check if the listing has at least one image
                        const img = document.createElement('img');
                        img.className = 'card-img-top';
                        if (listing.images && listing.images.length > 0) {
                            img.src = listing.images[0];
                        } else {
                            // Provide a default image or leave it blank
                            img.src = '/assets/images/no_image.png'; // Path to a default image
                            img.alt = 'Default Image';
                        }
                        img.alt = listing.name;

                        // Card body
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body';

                        // Listing name
                        const cardTitle = document.createElement('h5');
                        cardTitle.className = 'card-title';
                        cardTitle.textContent = listing.name;

                        // Listing description
                        const cardText = document.createElement('p');
                        cardText.className = 'card-text';
                        cardText.textContent = listing.desc;

                        // Listing price
                        const priceText = document.createElement('p');
                        priceText.className = 'card-text';
                        priceText.innerHTML = `<strong>Price:</strong> $${listing.price}`;

                        // Compile the card
                        cardBody.appendChild(cardTitle);
                        cardBody.appendChild(cardText);
                        cardBody.appendChild(priceText);
                        card.appendChild(img);
                        card.appendChild(cardBody);

                        // Append the card to the listings container
                        listingsContainer.appendChild(card);
                    });
                } else {
                    listingsContainer.innerHTML += '<p>No listings found or invalid data format.</p>';
                }
            }


            async function fetchChatInvitations(userId) {
                try {
                    const response = await fetch(`http://localhost:8000/api/chat/invitations/${userId}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch chat invitations');
                    }
                    const invitations = await response.json();
                    displayChatInvitations(invitations);
                } catch (error) {
                    console.error('Error fetching chat invitations:', error);
                }
            }

            function displayChatInvitations(invitations) {
                const chatsTabContent = document.getElementById('chats');
                chatsTabContent.innerHTML = ''; // Clear existing content

                invitations.forEach(invitation => {
                    const linkElement = document.createElement('a');
                    linkElement.href = `/pages/${invitation.chat_link}`;
                    linkElement.textContent = `Chat with ${invitation.buyer_id === globalUserId ? 'Seller' : 'Buyer'}`;
                    chatsTabContent.appendChild(linkElement);
                    chatsTabContent.appendChild(document.createElement('br')); // Add a line break after each link
                });
            }


            // Check for JWT and fetch profile
            document.addEventListener('DOMContentLoaded', () => {
                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    redirectToLogin();
                    return;
                }

                const payload = parseJwt(token);
                const globalUserId = payload.sub; // 'sub' contains the user ID

                fetchProfile(globalUserId);
                fetchReviews(globalUserId);
                fetchListings(globalUserId);
                fetchChatInvitations(globalUserId);
            });
        </script>

</body>

</html>